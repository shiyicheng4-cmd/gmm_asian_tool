<div style="margin-bottom:20px;">
  <label>粘贴 FootyStats 页面链接：</label>
  <input type="text" id="footyUrl" placeholder="粘贴链接后回车" style="width:80%;" />
</div>
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>xG/Poisson 价值投注计算器（含自动HA）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:18px;line-height:1.45}
  h1{font-size:20px;margin:0 0 12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{font-size:13px;color:#333}
  input{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:14px}
  .card{background:#f8f9fb;border:1px solid #e7e9ef;border-radius:12px;padding:14px;margin:10px 0}
  button{width:100%;padding:12px;border:0;border-radius:10px;background:#16a34a;color:#fff;font-weight:600;font-size:16px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px dashed #e5e7eb;padding:8px 6px;text-align:right}
  th:first-child,td:first-child{text-align:left}
  .ok{color:#16a34a;font-weight:700}
  .no{color:#ef4444;font-weight:700}
  small{color:#6b7280}
</style>
</head>
<body>
  <h1>投注</h1>

  <div class="card">
    <div class="grid">
      <div><label>主队 xG（进攻）</label><input id="hxg" type="number" step="0.01" value="1.60"></div>
      <div><label>主队 xGA（被创造）</label><input id="hxga" type="number" step="0.01" value="1.10"></div>
      <div><label>客队 xG（进攻）</label><input id="axg" type="number" step="0.01" value="1.30"></div>
      <div><label>客队 xGA（被创造）</label><input id="axga" type="number" step="0.01" value="1.40"></div>

      <div><label>主场优势系数（HA，1.05~1.15）</label><input id="ha" type="number" step="0.01" value="1.08"></div>
      <div><label>λ 计算权重（xG_for 占比）</label><input id="w" type="number" step="0.01" value="0.60"></div>

      <div><label>bet365 Over 2.5 赔率</label><input id="o_over" type="number" step="0.01" value="1.95"></div>
      <div><label>bet365 Under 2.5 赔率</label><input id="o_under" type="number" step="0.01" value="1.85"></div>
      <div><label>主胜赔率</label><input id="o_h" type="number" step="0.01" value="2.10"></div>
      <div><label>平局赔率</label><input id="o_d" type="number" step="0.01" value="3.40"></div>
      <div><label>客胜赔率</label><input id="o_a" type="number" step="0.01" value="3.60"></div>

      <div><label>EV 阈值（大小球）</label><input id="ev_ou" type="number" step="0.01" value="0.05"></div>
      <div><label>EV 阈值（1X2）</label><input id="ev_1x2" type="number" step="0.01" value="0.07"></div>
      <div><label>Edge 阈值（%）</label><input id="edge" type="number" step="0.01" value="0.03"></div>
      <div><label>Poisson 截断（最大进球）</label><input id="gmax" type="number" step="1" value="6"></div>
    </div>

    <!-- 新增：自动计算 HA 的小卡片 -->
    <div class="card" style="margin-top:14px">
      <b>自动计算主场优势系数（HA）</b>
      <div class="grid" style="margin-top:8px">
        <div><label>主队【主场】xG（来自 FootyStats）</label><input id="h_xg_home" type="number" step="0.01" placeholder="例如 1.96"></div>
        <div><label>主队【客场】xG（来自 FootyStats）</label><input id="h_xg_away" type="number" step="0.01" placeholder="例如 1.62"></div>
      </div>
      <small>HA = 主场xG ÷ 客场xG，并做稳健夹取（1.03～1.20）。填写任意一个为空时不自动更新。</small>
    </div>

    <p><button onclick="run()">计算</button></p>
    <small>λ 公式：λ<sub>home</sub>=(w·xG<sub>home</sub> + (1−w)·xGA<sub>away</sub>)·HA； λ<sub>away</sub>=(w·xG<sub>away</sub> + (1−w)·xGA<sub>home</sub>)/HA</small>
  </div>

  <div id="out"></div>

<script>
  function pois(k, lambda){ return Math.exp(-lambda) * Math.pow(lambda, k) / fact(k); }
  function fact(n){ let r=1; for(let i=2;i<=n;i++) r*=i; return r; }

  function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }

  function run(){
    const hxg=+hxg_el.value, hxga=+hxga_el.value, axg=+axg_el.value, axga=+axga_el.value;
    const ha=+ha_el.value, w=+w_el.value, gmax=+gmax_el.value;
    const o_over=+o_over_el.value, o_under=+o_under_el.value, o_h=+o_h_el.value, o_d=+o_d_el.value, o_a=+o_a_el.value;
    const evOU=+ev_ou_el.value, ev1x2=+ev_1x2_el.value, edgeThr=+edge_el.value;

    // lambdas
    const lamH = (w*hxg + (1-w)*axga)*ha;
    const lamA = (w*axg + (1-w)*hxga)/ha;

    // pmf arrays
    const pH = Array.from({length:gmax+1},(_,k)=>pois(k,lamH));
    const pA = Array.from({length:gmax+1},(_,k)=>pois(k,lamA));

    // joint sums
    let pDraw=0, pHome=0, pAway=0, pOver25=0, sum=0;
    for(let i=0;i<=gmax;i++){
      for(let j=0;j<=gmax;j++){
        const pij = pH[i]*pA[j];
        sum += pij;
        if(i===j) pDraw += pij; else if(i>j) pHome += pij; else pAway += pij;
        if(i+j>=3) pOver25 += pij;
      }
    }
    if(sum>0 && sum<0.999){ pDraw/=sum; pHome/=sum; pAway/=sum; pOver25/=sum; }

    // market de-juiced
    const qOver=1/o_over, qUnder=1/o_under;
    const qH=1/o_h, qD=1/o_d, qA=1/o_a;
    const sOU=qOver+qUnder, s1x2=qH+qD+qA;
    const pMOver=qOver/sOU, pMUnder=qUnder/sOU;
    const pMH=qH/s1x2, pMD=qD/s1x2, pMA=qA/s1x2;

    // edges & EV
    const edgeOver = pOver25 - pMOver;
    const evOver = pOver25 * o_over - 1;
    const decOver = (evOver>=evOU && edgeOver>=edgeThr) ? 'BUY' : 'PASS';

    const edgeH = pHome - pMH, edgeD = pDraw - pMD, edgeA = pAway - pMA;
    const evH = pHome*o_h-1, evD = pDraw*o_d-1, evA = pAway*o_a-1;
    const decH = (evH>=ev1x2 && edgeH>=edgeThr)?'BUY':'PASS';
    const decD = (evD>=ev1x2 && edgeD>=edgeThr)?'BUY':'PASS';
    const decA = (evA>=ev1x2 && edgeA>=edgeThr)?'BUY':'PASS';

    out.innerHTML = `
      <div class="card">
        <b>λ（预期进球）</b>
        <table>
          <tr><th>指标</th><th>数值</th></tr>
          <tr><td>λ Home</td><td>${lamH.toFixed(3)}</td></tr>
          <tr><td>λ Away</td><td>${lamA.toFixed(3)}</td></tr>
          <tr><td>预测总进球(λH+λA)</td><td>${(lamH+lamA).toFixed(2)}</td></tr>
        </table>
      </div>

      <div class="card">
        <b>模型概率（泊松，截断 ${gmax} 球，归一化）</b>
        <table>
          <tr><th>事件</th><th>概率</th></tr>
          <tr><td>Over 2.5</td><td>${(pOver25*100).toFixed(1)}%</td></tr>
          <tr><td>主胜</td><td>${(pHome*100).toFixed(1)}%</td></tr>
          <tr><td>平局</td><td>${(pDraw*100).toFixed(1)}%</td></tr>
          <tr><td>客胜</td><td>${(pAway*100).toFixed(1)}%</td></tr>
        </table>
      </div>

      <div class="card">
        <b>市场去水概率（由 bet365 赔率换算）</b>
        <table>
          <tr><th>事件</th><th>概率</th></tr>
          <tr><td>Over 2.5</td><td>${(pMOver*100).toFixed(1)}%</td></tr>
          <tr><td>主胜</td><td>${(pMH*100).toFixed(1)}%</td></tr>
          <tr><td>平局</td><td>${(pMD*100).toFixed(1)}%</td></tr>
          <tr><td>客胜</td><td>${(pMA*100).toFixed(1)}%</td></tr>
        </table>
      </div>

      <div class="card">
        <b>Edge / EV 与决策</b>
        <table>
          <tr><th>市场</th><th>Edge(模型-市场)</th><th>EV</th><th>决定</th></tr>
          <tr><td>Over 2.5 @ ${o_over}</td><td>${(edgeOver*100).toFixed(1)}%</td><td>${(evOver*100).toFixed(1)}%</td><td class="${decOver==='BUY'?'ok':'no'}">${decOver}</td></tr>
          <tr><td>主胜 @ ${o_h}</td><td>${(edgeH*100).toFixed(1)}%</td><td>${(evH*100).toFixed(1)}%</td><td class="${decH==='BUY'?'ok':'no'}">${decH}</td></tr>
          <tr><td>平局 @ ${o_d}</td><td>${(edgeD*100).toFixed(1)}%</td><td>${(evD*100).toFixed(1)}%</td><td class="${decD==='BUY'?'ok':'no'}">${decD}</td></tr>
          <tr><td>客胜 @ ${o_a}</td><td>${(edgeA*100).toFixed(1)}%</td><td>${(evA*100).toFixed(1)}%</td><td class="${decA==='BUY'?'ok':'no'}">${decA}</td></tr>
        </table>
      </div>
    `;
  }

  // 元素引用
  const hxg_el= document.getElementById('hxg');
  const hxga_el=document.getElementById('hxga');
  const axg_el= document.getElementById('axg');
  const axga_el=document.getElementById('axga');
  const ha_el= document.getElementById('ha');
  const w_el=  document.getElementById('w');
  const o_over_el=document.getElementById('o_over');
  const o_under_el=document.getElementById('o_under');
  const o_h_el=document.getElementById('o_h');
  const o_d_el=document.getElementById('o_d');
  const o_a_el=document.getElementById('o_a');
  const ev_ou_el=document.getElementById('ev_ou');
  const ev_1x2_el=document.getElementById('ev_1x2');
  const edge_el=document.getElementById('edge');
  const gmax_el=document.getElementById('gmax');
  const out=document.getElementById('out');

  // 新增：自动 HA 相关
  const h_xg_home = document.getElementById('h_xg_home');
  const h_xg_away = document.getElementById('h_xg_away');

  function autoHA(){
    const a = parseFloat(h_xg_home.value);
    const b = parseFloat(h_xg_away.value);
    if(!isFinite(a) || !isFinite(b) || b<=0) return;
    // 稳健夹取，避免极端值
    const raw = a / b;
    const ha = clamp(raw, 1.03, 1.20);
    ha_el.value = ha.toFixed(2);
  }
  h_xg_home.addEventListener('input', autoHA);
  h_xg_away.addEventListener('input', autoHA);

  run(); // 初次渲染
</script>
  <script>
document.getElementById("footyUrl").addEventListener("change", async function() {
    const url = this.value.trim();
    if (!url) return;

    try {
        const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
        const data = await res.json();
        const html = data.contents;

        // 从 HTML 里匹配主队和客队的 xG / xGA
        const regex = /([\d.]+)\s*<\/td>\s*<td>([\d.]+)\s*<\/td>/g;
        const matches = [...html.matchAll(regex)];

        if (matches.length >= 2) {
            // 这里只是演示，你需要对应表格顺序对号入座
            document.querySelector('input[name="home_xg"]').value = matches[0][1];
            document.querySelector('input[name="home_xga"]').value = matches[0][2];
            document.querySelector('input[name="away_xg"]').value = matches[1][1];
            document.querySelector('input[name="away_xga"]').value = matches[1][2];
            alert("xG / xGA 已自动填入");
        } else {
            alert("未能识别数据，请检查 URL 是否正确");
        }
    } catch (err) {
        alert("抓取数据失败：" + err.message);
    }
});
</script>
</body>
</html>
